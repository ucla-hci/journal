<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Journey Alpha</title>
	<link rel="stylesheet" type="text/css" href="css/style_exp.css" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
	<link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-light-blue.css">
	<!-- jQuery -->
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script src="contextMenu/jquery.ui.position.min.js" type="text/javascript"></script>
	<!-- contextMenu -->
	<script src="contextMenu/jquery.contextMenu.js" type="text/javascript"></script>
	<link href="contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
	<!-- journal Core -->
	<script type="text/javascript" src="js/journal.js"></script>
	<!-- ot.js -->
	<script src="ot.js/text-operation.js"></script>
	<script src="ot.js/selection.js"></script>
	<script src="ot.js/wrapped-operation.js"></script>
	<script src="ot.js/undo-manager.js"></script>
	<script src="ot.js/client.js"></script>
	<script src="ot.js/codemirror-adapter.js"></script>
	<script src="ot.js/socketio-adapter.js"></script>
	<script src="ot.js/editor-client.js"></script>
	<!-- CodeMirror -->
	<link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
	<script src="node_modules/codemirror/lib/codemirror.js"></script>
	<script src="node_modules/codemirror/addon/search/searchcursor.js"></script>
	<script src="node_modules/codemirror/addon/selection/mark-selection.js"></script>
	<style>
		.CodeMirror {border-top: 1px solid black; border-bottom: 1px solid black;}
		.CodeMirror-selectedtext { color: white; }
		.styled-background { background-color: #ff7; }
		.AutoSuggest-font { color: #646464; background-color: #C0C0C0;}
	</style>
	<!-- socket.io -->
	<script src="node_modules/socket.io-client/dist/socket.io.js"></script>

</head>
<body>
	<header>
		<div id="buttons">
			<button type="button" onclick="control(1)">Turn on suggestion</button>
			<button type="button" onclick="control(2)">Turn on highlight</button>
			<button type="button" onclick="control(3)">Get Keybd Log</button>
			<button type="button" onclick="control(4)">Get Mouse Log</button>
		</div>
		<div id="tags">
			<footer id="clear_footer"></footer>
		</div>
	</header>

	<aside class="box" id="test">
        <ul id="logTable">
            <li>
                <h4 id="title">Logs</h4>
            </li>

		</ul>
		<!--<div id="popup">Selected text is negative</div>-->
	</aside>

	<div class="container">
		<div class="backdrop">
			<div class="highlights"></div>
		</div>
		<div id="myModal" class="modal-content" style="border: 5px; opacity: 1; padding: 0 0 2rem 0;">
			<span class="close">&times;</span>
			<h3 style=" padding: 0 2rem;"><span id="cog_dist" style="background-color: #dcb1e5; border-radius: 5px;">Cognitive Distortion</span></h2>
			<h3 style="color:#BABABA; padding: 0 2rem;">Definition</h3>
				<p id="cd_def" style="padding: 0 3rem;">This cognitive distortion...</p>
			<h3 style="color:#BABABA; padding: 0 2rem;">Examples</h3>
				<ol id="cd_ex" style="padding: 0 7rem;">
					<li id="ex1">Coffee</li>
					<!--<li id="ex2">Tea</li>
					<li id="ex3">Milk</li>-->
				</ol> 
		</div>
		<textarea id="write" autofocus spellcheck="false"></textarea>
		<!-- init client -->
		<script>
			var socket = io();
			var cm;
			socket.on('doc', function(data) {
			  cm = CodeMirror.fromTextArea(document.getElementById('write'), {lineNumbers: true, styleSelectedText: true});
			  cm.setValue(data.str);
			  var serverAdapter = new ot.SocketIOAdapter(socket);
			  var editorAdapter = new ot.CodeMirrorAdapter(cm);
			  var client = new ot.EditorClient(data.revision, data.clients, serverAdapter, editorAdapter);
			})

			function Test(){
				let command = "ShakeHand:";
				socket.emit("sentToServer", command);
				console.log(command);
				log(command);
			}

			function control(i){
				let command = "On:"

				switch (i) {
					case 1: command += "AutoSug"; break;
					case 3: command += "Keyboard"; break;
					case 4: command += "Mouse"; break;
				}
				log(command);
				socket.emit("sentToServer", command);
			}

			function log(sentence) {
				let html = "<li><p>" + sentence + "</p></li>"
				$("#logTable").append(html);
			}

			$(function() {
				$.contextMenu({
					selector: '.CodeMirror',
					callback: function(key, options) {
						console.log("Click atï¼š" + key);
					},
					items: {
						"suggest": {
							name: "Suggest", 
							icon: "edit",
							callback: function(itemKey, opt, rootMenu, originalEvent) {
								/*
								console.log("fetch:")
								console.log("loc:", cm.getCursor("from"), cm.getCursor("to"));
								console.log("content:", cm.getSelection())*/
								let start = cm.getCursor("to");
								let _line = parseInt(start["line"]);
								let _ch = parseInt(start["ch"]);
								let sentence = prompt("Please type your suggestion below:","...");
								if(sentence){
									cm.replaceRange(sentence, start);
									let end = cm.getCursor("to");
									cm.markText(start, end, {className: "AutoSuggest-font"});

									let command = "AutoSug:(" + _line + "," + _ch + '),(' + end.line + "," + end.ch + ")";
									socket.emit("sentToServer", command);
									log(command);
								}
							}
						},
						"highlight": {
							name: "Highlight", 
							icon: "fa-flag",
							callback: function(itemKey, opt, rootMenu, originalEvent) {
								if (cm.somethingSelected()) {
									let from_line = parseInt(cm.getCursor("from")["line"])
									let from_ch = parseInt(cm.getCursor("from")["ch"])
									let to_line = parseInt(cm.getCursor("to")["line"])
									let to_ch = parseInt(cm.getCursor("to")["ch"])
									console.log({line: from_line, ch: from_ch}, {line: to_line, ch: to_ch})
									cm.markText({line: from_line, ch: from_ch}, {line: to_line, ch: to_ch}, {className: "styled-background"})
									let command = "HighLt:(" + from_line + "," + from_ch + '),(' + to_line + ',' + to_ch + '),' + '[distortion-type]';
									socket.emit("sentToServer", command);
									console.log(command);
									log(command);
								}
								
							}
						},
						"feedback": {
							name: "Feedback", 
							icon: "fa-beer",
							callback: function(itemKey, opt, rootMenu, originalEvent) {
								let from_line = parseInt(cm.getCursor("from")["line"])
								let from_ch = parseInt(cm.getCursor("from")["ch"])
								let to_line = parseInt(cm.getCursor("to")["line"])
								let to_ch = parseInt(cm.getCursor("to")["ch"])
								let sentence = prompt("Please type your feedback below:","...");
								if(sentence){
									let command = "FeedBk:(" + from_line + "," + from_ch + '),(' + to_line + ',' + to_ch + '),' + sentence;
									socket.emit("sentToServer", command);
									console.log(command);
									log(command);
								}
							}
						},
						"undo": {
							name: "Undo", 
							icon: "fa-undo",
							callback: function(itemKey, opt, rootMenu, originalEvent) {
								cm.undo()
							}
						},
						"redo": {
							name: "Redo", 
							icon: "fa-repeat",
							callback: function(itemKey, opt, rootMenu, originalEvent) {
								cm.redo()
							}
						},
						"clear": {
							name: "Clear All", 
							icon: "delete",
							callback: function(itemKey, opt, rootMenu, originalEvent) {
								console.log("clear all")
								console.log(cm.setValue(""));
							}
						}
					}
				});
			});
		</script>
	</div>
</body>

</html>